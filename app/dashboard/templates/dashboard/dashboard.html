{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Transaction List</h2>
    <table class="table table-bordered mb-4">
        <thead>
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Date</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Balance</th>
            </tr>
        </thead>
        <tbody id="transactionList">
            <!-- Data will be populated here by JavaScript -->
        </tbody>
    </table>

    <h3>Transaction Summary (Charts)</h3>
    
    <!-- Line Chart: Transaction Amounts Over Time -->
    <canvas id="transactionLineChart" width="400" height="200"></canvas>
    
    <!-- Bar Chart: Total Amount Spent by Category -->
    <canvas id="transactionBarChart" width="400" height="200"></canvas>
    
    <!-- Pie Chart: Distribution of Transaction Types -->
    <canvas id="transactionPieChart" width="400" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Fetch transaction data from the API
    fetch('/dashboard/api/transactions')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('transactionList');
            let labels = [];
            let amounts = [];
            let categories = {};
            let transactionTypes = { 'Income': 0, 'Expense': 0, 'Transfer': 0 };

            // Iterate over the fetched data and create the list items and chart data
            data.forEach(tx => {
                // Fill the transaction list
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tx.id}</td>
                    <td>${tx.user_id || 1}</td>
                    <td>${tx.date}</td>
                    <td>${tx.description}</td>
                    <td>$${tx.amount}</td>
                    <td>$${tx.balance}</td>
                `;
                list.appendChild(row);

                // Prepare data for the line chart (using the date as labels and amounts as values)
                labels.push(tx.date);  
                amounts.push(tx.amount);

                // Prepare data for the bar chart (category amounts)
                if (categories[tx.category]) {
                    categories[tx.category] += tx.amount;
                } else {
                    categories[tx.category] = tx.amount;
                }

                // Prepare data for the pie chart (transaction types)
                if (tx.transaction_type) {
                    transactionTypes[tx.transaction_type] += tx.amount;
                }
            });

            // Create the line chart (Transaction Amounts Over Time)
            const lineCtx = document.getElementById('transactionLineChart').getContext('2d');
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,  
                    datasets: [{
                        label: 'Transaction Amount',
                        data: amounts,
                        borderColor: '#4bc0c0',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4bc0c0',
                        pointHoverBackgroundColor: '#4bc0c0',
                        pointHoverBorderColor: '#fff',
                        fill: true,
                        tension: 0.3,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Transaction Amounts Over Time',
                            font: {
                                size: 18,
                            },
                            color: '#333'
                        },
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    family: 'Cabin, sans-serif',
                                },
                                color: '#666'
                            },
                            grid: {
                                color: '#e1e1e1',
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 12,
                                    family: 'Cabin, sans-serif',
                                },
                                color: '#666'
                            },
                            grid: {
                                color: '#e1e1e1',
                            }
                        }
                    }
                }
            });

            // Create the bar chart (Total Amount Spent by Category)
            const barCtx = document.getElementById('transactionBarChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        label: 'Total Spent by Category',
                        data: Object.values(categories),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: '#4bc0c0',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Amount Spent by Category',
                            font: {
                                size: 18,
                            },
                            color: '#333'
                        },
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    family: 'Cabin, sans-serif',
                                },
                                color: '#666'
                            },
                            grid: {
                                color: '#e1e1e1',
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 12,
                                    family: 'Cabin, sans-serif',
                                },
                                color: '#666'
                            },
                            grid: {
                                color: '#e1e1e1',
                            }
                        }
                    }
                }
            });

            // Create the pie chart (Distribution of Transaction Types)
            const pieCtx = document.getElementById('transactionPieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(transactionTypes),
                    datasets: [{
                        label: 'Transaction Types Distribution',
                        data: Object.values(transactionTypes),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Transaction Types',
                            font: {
                                size: 18,
                            },
                            color: '#333'
                        },
                    },
                }
            });
        })
        .catch(error => console.error('Error fetching transactions:', error));
</script>
{% endblock %}
